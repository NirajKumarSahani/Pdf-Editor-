<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Editor - Edit Locally</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PDF.js for rendering PDFs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <!-- Fabric.js for canvas-based editing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <!-- pdf-lib.js for creating the final PDF -->
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        #toolbar button.active {
            background-color: #3b82f6;
            color: white;
        }
        #pages-thumbnails .thumbnail.active {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3b82f6;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-200 text-gray-800">

    <div id="loader-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex flex-col items-center justify-center z-50 hidden">
        <div class="loader"></div>
        <p id="loader-text" class="text-white mt-4 text-lg">Loading...</p>
    </div>

    <!-- AI Modal -->
    <div id="ai-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl transform transition-all">
            <div class="flex items-center justify-between border-b pb-3">
                <h3 id="ai-modal-title" class="text-xl font-semibold">AI Assistant</h3>
                <button id="ai-modal-close-btn" class="text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div id="ai-modal-content" class="mt-4 mb-6 max-h-[60vh] overflow-y-auto">
                <!-- AI content will be injected here -->
            </div>
            <div class="flex justify-end space-x-3 border-t pt-4">
                 <button id="ai-modal-secondary-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Close</button>
                 <button id="ai-modal-action-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Action</button>
            </div>
        </div>
    </div>


    <div class="flex h-screen">
        <!-- Toolbar & Pages Sidebar -->
        <aside class="w-64 bg-white shadow-lg flex flex-col">
            <div class="p-4 border-b text-center">
                <h1 class="text-xl font-bold text-gray-900">PDF Editor</h1>
            </div>
            
            <div id="pdf-controls" class="p-4 border-b hidden">
                 <!-- Main Toolbar -->
                <div id="toolbar" class="grid grid-cols-3 gap-2 mb-4">
                    <button data-tool="select" title="Select & Move" class="active flex items-center justify-center p-2 rounded-lg border hover:bg-gray-100 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122" /></svg>
                    </button>
                    <button data-tool="text" title="Add Text" class="flex items-center justify-center p-2 rounded-lg border hover:bg-gray-100 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 5h12M9 3v12M11 5h10M16 3v12M4 9h1M4 12h1M4 15h1M4 18h1M11 9h1M11 12h1M11 15h1M11 18h1" /></svg>
                    </button>
                    <button data-tool="draw" title="Draw" class="flex items-center justify-center p-2 rounded-lg border hover:bg-gray-100 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                    </button>
                    <button data-tool="rectangle" title="Add Rectangle" class="flex items-center justify-center p-2 rounded-lg border hover:bg-gray-100 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 4h6a2 2 0 012 2v12a2 2 0 01-2 2H9a2 2 0 01-2-2V6a2 2 0 012-2z" /></svg>
                    </button>
                     <button data-tool="eraser" title="Eraser" class="flex items-center justify-center p-2 rounded-lg border hover:bg-gray-100 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"/> <path d="M19 20h-10.5l-4.21 -4.3a1 1 0 0 1 0 -1.41l10 -10a1 1 0 0 1 1.41 0l5 5a1 1 0 0 1 0 1.41l-9.2 9.3" /> <path d="M18 13.3l-6.3 -6.3" /> </svg>
                    </button>
                     <button data-tool="ai-generate" title="✨ AI Generate Content" class="flex items-center justify-center p-2 rounded-lg border hover:bg-gray-100 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>
                    </button>
                </div>

                <!-- Tool Options -->
                 <div id="tool-options" class="space-y-4">
                    <div id="brush-controls" class="hidden space-y-2">
                        <div>
                           <label for="brush-size" class="block text-sm font-medium text-gray-700">Brush Size</label>
                           <input id="brush-size" type="range" min="1" max="50" value="5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        </div>
                        <div id="brush-color-control" class="hidden">
                           <label for="brush-color" class="block text-sm font-medium text-gray-700">Brush Color</label>
                           <input id="brush-color" type="color" value="#ff0000" class="w-full h-10 border-gray-300 rounded-md p-0 cursor-pointer">
                        </div>
                    </div>
                    <button id="delete-selected-btn" class="hidden w-full text-center cursor-pointer p-2 rounded-lg border bg-red-50 hover:bg-red-100 text-red-700 transition-colors flex items-center justify-center">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                         Delete Selected
                    </button>
                </div>

                 <!-- Image Upload -->
                <label for="image-upload" title="Add Image" class="w-full text-center cursor-pointer p-2 rounded-lg border bg-white hover:bg-gray-100 transition-colors flex items-center justify-center my-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                    Add Image
                </label>
                <input type="file" id="image-upload" class="hidden" accept="image/*">
                <!-- AI Features -->
                <button id="summarize-page-btn" title="✨ Summarize Page" class="w-full text-center cursor-pointer p-2 rounded-lg border bg-blue-50 hover:bg-blue-100 transition-colors flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                    Summarize Page
                </button>
            </div>

            <!-- Pages List -->
            <div id="pages-list" class="flex-grow overflow-y-auto p-2 hidden">
                 <h2 class="text-md font-semibold mb-2 text-center">Pages</h2>
                 <div id="pages-thumbnails" class="space-y-2"></div>
                 <div class="mt-4 flex justify-around">
                     <button id="delete-page-btn" title="Delete Selected Page" class="px-3 py-1 bg-red-500 text-white rounded-md hover:bg-red-600 transition-colors text-sm">Delete Page</button>
                 </div>
            </div>
        </aside>

        <!-- Main Editor Area -->
        <main class="flex-grow flex items-center justify-center p-4 bg-gray-200 relative">
            <div id="upload-placeholder" class="text-center">
                <svg class="mx-auto h-16 w-16 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                <h2 class="mt-4 text-2xl font-semibold">Load a PDF to start editing</h2>
                <p class="mt-2 text-gray-500">Your files will be processed locally.</p>
                <div class="mt-6">
                    <label for="pdf-upload" class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition-colors cursor-pointer">
                        Select PDF
                    </label>
                    <input type="file" id="pdf-upload" class="hidden" accept=".pdf">
                </div>
            </div>

            <div id="canvas-container" class="shadow-lg hidden">
                <canvas id="pdf-canvas"></canvas>
            </div>
            
            <button id="download-btn" class="hidden absolute bottom-5 right-5 px-6 py-3 bg-green-600 text-white font-bold rounded-lg shadow-xl hover:bg-green-700 transition-transform transform hover:scale-105">
                Download PDF
            </button>
        </main>
    </div>

    <script>
        // Set workerSrc for pdf.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js`;

        const pdfUpload = document.getElementById('pdf-upload');
        const imageUpload = document.getElementById('image-upload');
        const downloadBtn = document.getElementById('download-btn');
        const deletePageBtn = document.getElementById('delete-page-btn');
        
        const toolbar = document.getElementById('toolbar');
        const canvasContainer = document.getElementById('canvas-container');
        const uploadPlaceholder = document.getElementById('upload-placeholder');
        const pagesThumbnails = document.getElementById('pages-thumbnails');
        
        const loaderOverlay = document.getElementById('loader-overlay');
        const loaderText = document.getElementById('loader-text');

        // Tool Options
        const brushControls = document.getElementById('brush-controls');
        const brushSizeSlider = document.getElementById('brush-size');
        const brushColorControl = document.getElementById('brush-color-control');
        const brushColorInput = document.getElementById('brush-color');
        const deleteSelectedBtn = document.getElementById('delete-selected-btn');
        
        // AI Modal elements
        const aiModal = document.getElementById('ai-modal');
        const aiModalTitle = document.getElementById('ai-modal-title');
        const aiModalContent = document.getElementById('ai-modal-content');
        const aiModalCloseBtn = document.getElementById('ai-modal-close-btn');
        const aiModalSecondaryBtn = document.getElementById('ai-modal-secondary-btn');
        const aiModalActionBtn = document.getElementById('ai-modal-action-btn');
        
        const summarizePageBtn = document.getElementById('summarize-page-btn');

        let fabricCanvas;
        let pdfDoc = null;
        let currentPageNum = 1;
        let pageStates = {}; // To store fabric canvas JSON for each page
        let activeTool = 'select';
        
        const GEMINI_API_KEY = ""; // Provided by the environment

        // --- Gemini API Call ---
        async function retryWithExponentialBackoff(func, maxRetries = 3, initialDelay = 1000) {
            let delay = initialDelay;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    return await func();
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    console.warn(`API call failed, retrying in ${delay}ms...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }
        }

        async function callGemini(prompt) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
            
            const apiCall = async () => {
                 const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });

                if (!response.ok) {
                    const errorBody = await response.json();
                    console.error("Gemini API Error:", errorBody);
                    throw new Error(`API request failed with status ${response.status}`);
                }
                
                const result = await response.json();
                const candidate = result.candidates?.[0];
                if (candidate && candidate.content?.parts?.[0]?.text) {
                    return candidate.content.parts[0].text;
                } else {
                    throw new Error("Invalid response structure from Gemini API");
                }
            };
            
            return retryWithExponentialBackoff(apiCall);
        }

        function initFabricCanvas() {
            fabricCanvas = new fabric.Canvas('pdf-canvas');
            fabricCanvas.on('mouse:down', handleCanvasMouseDown);
            
            // Selection listeners to show/hide delete button
            fabricCanvas.on('selection:created', () => deleteSelectedBtn.classList.remove('hidden'));
            fabricCanvas.on('selection:updated', () => deleteSelectedBtn.classList.remove('hidden'));
            fabricCanvas.on('selection:cleared', () => deleteSelectedBtn.classList.add('hidden'));

        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file && file.type === 'application/pdf') {
                const fileReader = new FileReader();
                fileReader.onload = function() {
                    const typedarray = new Uint8Array(this.result);
                    loadPdf(typedarray);
                };
                fileReader.readAsArrayBuffer(file);
            }
        }

        async function loadPdf(pdfData) {
            showLoader('Loading PDF...');
            try {
                const loadingTask = pdfjsLib.getDocument({data: pdfData});
                pdfDoc = await loadingTask.promise;
                pageStates = {}; // Reset states for new PDF
                currentPageNum = 1;
                
                document.getElementById('pdf-controls').classList.remove('hidden');
                document.getElementById('pages-list').classList.remove('hidden');
                uploadPlaceholder.classList.add('hidden');
                canvasContainer.classList.remove('hidden');
                downloadBtn.classList.remove('hidden');

                if (!fabricCanvas) initFabricCanvas();
                
                await renderAllThumbnails();
                await renderPage(currentPageNum);
            } catch (error) {
                console.error("Error loading PDF:", error);
                alert("Could not load PDF. The file might be corrupted or protected.");
            } finally {
                hideLoader();
            }
        }
        
        async function renderPage(num) {
            if (!pdfDoc || num < 1 || num > pdfDoc.numPages) return;
            
            // Save current page state before switching
            if (fabricCanvas && fabricCanvas.getObjects().length > 0) {
                 pageStates[currentPageNum] = fabricCanvas.toJSON();
            }

            currentPageNum = num;
            showLoader(`Loading page ${num}...`);
            
            const page = await pdfDoc.getPage(num);
            const viewport = page.getViewport({ scale: 1.5 });

            fabricCanvas.setWidth(viewport.width);
            fabricCanvas.setHeight(viewport.height);

            const renderContext = {
                canvasContext: document.createElement('canvas').getContext('2d'),
                viewport: viewport
            };
            renderContext.canvasContext.canvas.width = viewport.width;
            renderContext.canvasContext.canvas.height = viewport.height;
            
            await page.render(renderContext).promise;
            
            fabricCanvas.clear();
            const bgImage = new fabric.Image(renderContext.canvasContext.canvas, {
                selectable: false,
                evented: false,
            });
            fabricCanvas.setBackgroundImage(bgImage, fabricCanvas.renderAll.bind(fabricCanvas));

            // Load saved state for the new page
            if (pageStates[num]) {
                fabricCanvas.loadFromJSON(pageStates[num], fabricCanvas.renderAll.bind(fabricCanvas));
            }
            
            updateActiveThumbnail();
            setTool(activeTool); // Re-apply active tool settings
            hideLoader();
        }
        
        async function renderAllThumbnails() {
            pagesThumbnails.innerHTML = '';
            for (let i = 1; i <= pdfDoc.numPages; i++) {
                const page = await pdfDoc.getPage(i);
                const viewport = page.getViewport({ scale: 0.2 });
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                await page.render({ canvasContext: context, viewport: viewport }).promise;

                const thumbnail = document.createElement('div');
                thumbnail.className = 'thumbnail p-1 border-2 border-transparent rounded-md cursor-pointer hover:border-blue-300';
                thumbnail.dataset.pageNum = i;
                thumbnail.appendChild(canvas);
                thumbnail.addEventListener('click', () => renderPage(i));
                pagesThumbnails.appendChild(thumbnail);
            }
            updateActiveThumbnail();
        }

        function updateActiveThumbnail() {
            document.querySelectorAll('.thumbnail').forEach(thumb => {
                thumb.classList.remove('active');
                if (parseInt(thumb.dataset.pageNum) === currentPageNum) {
                    thumb.classList.add('active');
                }
            });
        }
        
        toolbar.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (button && button.dataset.tool) {
                 if (button.dataset.tool === 'ai-generate') {
                    openAiGenerateModal();
                } else {
                    setTool(button.dataset.tool);
                }
            }
        });

        function setTool(tool) {
            activeTool = tool;
            toolbar.querySelectorAll('button').forEach(btn => {
                if (btn.dataset.tool !== 'ai-generate') {
                    btn.classList.remove('active');
                }
            });
            const activeButton = toolbar.querySelector(`[data-tool="${tool}"]`);
            if (activeButton) {
                activeButton.classList.add('active');
            }

            if (tool === 'draw' || tool === 'eraser') {
                fabricCanvas.isDrawingMode = true;
                brushControls.classList.remove('hidden');
                if (tool === 'draw') {
                    brushColorControl.classList.remove('hidden');
                    fabricCanvas.freeDrawingBrush = new fabric.PencilBrush(fabricCanvas);
                    fabricCanvas.freeDrawingBrush.color = brushColorInput.value;
                } else { // Eraser
                    brushColorControl.classList.add('hidden');
                    fabricCanvas.freeDrawingBrush = new fabric.EraserBrush(fabricCanvas);
                }
                fabricCanvas.freeDrawingBrush.width = parseInt(brushSizeSlider.value, 10);
            } else {
                fabricCanvas.isDrawingMode = false;
                brushControls.classList.add('hidden');
            }

            fabricCanvas.selection = tool === 'select';
            fabricCanvas.getObjects().forEach(o => o.set({ selectable: tool === 'select', evented: true }));
            fabricCanvas.renderAll();
        }

        brushSizeSlider.addEventListener('input', (e) => {
            if (fabricCanvas.isDrawingMode) {
                fabricCanvas.freeDrawingBrush.width = parseInt(e.target.value, 10);
            }
        });
        
        brushColorInput.addEventListener('input', (e) => {
            if (fabricCanvas.isDrawingMode && activeTool === 'draw') {
                fabricCanvas.freeDrawingBrush.color = e.target.value;
            }
        });

        deleteSelectedBtn.addEventListener('click', () => {
            const activeObjects = fabricCanvas.getActiveObjects();
            if (activeObjects.length) {
                activeObjects.forEach(obj => fabricCanvas.remove(obj));
                fabricCanvas.discardActiveObject();
                fabricCanvas.renderAll();
            }
        });


        function handleCanvasMouseDown(o) {
            if (!o.target) {
                const pointer = fabricCanvas.getPointer(o.e);
                if (activeTool === 'text') {
                    const text = new fabric.IText('Your Text Here', {
                        left: pointer.x,
                        top: pointer.y,
                        fill: 'black',
                        fontSize: 24,
                        fontFamily: 'Inter'
                    });
                    fabricCanvas.add(text);
                    text.enterEditing();
                    setTool('select');
                } else if (activeTool === 'rectangle') {
                     const rect = new fabric.Rect({
                        left: pointer.x,
                        top: pointer.y,
                        fill: 'transparent',
                        stroke: 'red',
                        strokeWidth: 3,
                        width: 100,
                        height: 50,
                    });
                    fabricCanvas.add(rect);
                    setTool('select');
                }
            }
        }
        
        imageUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    fabric.Image.fromURL(event.target.result, (img) => {
                        img.scaleToWidth(200);
                        img.set({ left: 50, top: 50 });
                        fabricCanvas.add(img);
                    });
                };
                reader.readAsDataURL(file);
            }
            e.target.value = ''; // Reset input
        });

        deletePageBtn.addEventListener('click', async () => {
            if (!pdfDoc || pdfDoc.numPages <= 1) {
                alert("Cannot delete the last page.");
                return;
            }
            alert("Page deletion is a complex feature. For now, edits are saved per page, but deletion will be supported in a future version.");
        });
        
        // --- AI Feature Handlers ---
        summarizePageBtn.addEventListener('click', async () => {
            showLoader('Analyzing page...');
            try {
                const page = await pdfDoc.getPage(currentPageNum);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(' ');

                if (pageText.trim().length < 20) {
                    alert("Not enough text on this page to summarize.");
                    hideLoader();
                    return;
                }
                
                const prompt = "Summarize the following content from a PDF page into a few key bullet points:\n\n" + pageText;
                showLoader('✨ Generating summary...');
                const summary = await callGemini(prompt);
                
                aiModalTitle.textContent = `✨ Summary of Page ${currentPageNum}`;
                aiModalContent.innerHTML = `<div class="prose max-w-none">${summary.replace(/\n/g, '<br>')}</div>`;
                aiModalActionBtn.classList.add('hidden');
                aiModal.classList.remove('hidden');

            } catch (error) {
                console.error("Summarization error:", error);
                alert("Failed to generate summary. Please check the console for details.");
            } finally {
                hideLoader();
            }
        });

        function openAiGenerateModal() {
            aiModalTitle.textContent = '✨ AI Content Generation';
            aiModalContent.innerHTML = `
                <p class="text-sm text-gray-600 mb-2">Describe the content you want to generate. Be specific!</p>
                <textarea id="ai-prompt-textarea" class="w-full h-32 p-2 border rounded-md" placeholder="e.g., 'Write a short paragraph about the benefits of renewable energy.'"></textarea>
                <div id="ai-result-area" class="mt-4 p-2 border rounded-md bg-gray-50 hidden"></div>
            `;
            aiModalActionBtn.textContent = 'Generate';
            aiModalActionBtn.classList.remove('hidden');
            aiModalActionBtn.onclick = handleAiGeneration;
            aiModal.classList.remove('hidden');
        }

        async function handleAiGeneration() {
            const promptTextarea = document.getElementById('ai-prompt-textarea');
            const prompt = promptTextarea.value;
            if (prompt.trim().length < 10) {
                alert("Please enter a more detailed prompt.");
                return;
            }
            
            showLoader('✨ Generating content...');
            try {
                const result = await callGemini(prompt);
                
                const resultArea = document.getElementById('ai-result-area');
                promptTextarea.classList.add('hidden');
                resultArea.textContent = result;
                resultArea.classList.remove('hidden');

                aiModalActionBtn.textContent = 'Add to PDF';
                aiModalActionBtn.onclick = () => {
                    addTextToCanvas(result);
                    aiModal.classList.add('hidden');
                };

            } catch (error) {
                console.error("AI Generation error:", error);
                alert("Failed to generate content.");
            } finally {
                hideLoader();
            }
        }
        
        function addTextToCanvas(text) {
             const textObject = new fabric.IText(text, {
                left: fabricCanvas.width / 4,
                top: fabricCanvas.height / 4,
                fill: 'black',
                fontSize: 20,
                fontFamily: 'Inter',
                width: fabricCanvas.width / 2,
            });
            fabricCanvas.add(textObject);
            fabricCanvas.setActiveObject(textObject);
            fabricCanvas.renderAll();
        }

        [aiModalCloseBtn, aiModalSecondaryBtn].forEach(btn => {
            btn.addEventListener('click', () => aiModal.classList.add('hidden'));
        });

        // Function to promisify fabric.js loadFromJSON
        function loadFabricStateAsync(canvas, state) {
            return new Promise(resolve => {
                canvas.loadFromJSON(state, () => {
                    canvas.renderAll();
                    resolve();
                });
            });
        }

        async function savePdf() {
            showLoader('Saving PDF...');
            try {
                // Save the very last edits on the current page
                if (fabricCanvas) {
                    pageStates[currentPageNum] = fabricCanvas.toJSON();
                }

                const { PDFDocument } = PDFLib;
                const pdfBytes = await pdfDoc.getData();
                const newPdfDoc = await PDFDocument.load(pdfBytes);

                const pageIndices = Array.from(newPdfDoc.getPageIndices());

                for (const i of pageIndices) {
                    const pageNum = i + 1;
                    if (!pageStates[pageNum]) continue;
                    
                    showLoader(`Applying edits to page ${pageNum}...`);

                    const page = newPdfDoc.getPage(i);
                    const { width, height } = page.getSize();
                    
                    const tempCanvas = document.createElement('canvas');
                    tempCanvas.width = width * 1.5;
                    tempCanvas.height = height * 1.5;
                    const tempFabric = new fabric.Canvas(tempCanvas);
                    
                    const state = JSON.parse(JSON.stringify(pageStates[pageNum]));
                    // Remove the background image to only export the overlay
                    state.backgroundImage = null;
                    
                    // Scale fabric objects to match the higher resolution temp canvas
                    state.objects.forEach(obj => {
                        obj.left *= 1.5;
                        obj.top *= 1.5;
                        obj.scaleX *= 1.5;
                        obj.scaleY *= 1.5;
                        if(obj.fontSize) obj.fontSize *= 1.5;
                        if(obj.strokeWidth) obj.strokeWidth *= 1.5;
                    });
                    
                    await loadFabricStateAsync(tempFabric, state);
                    
                    const dataUrl = tempFabric.toDataURL({ format: 'png' });
                    const pngImage = await newPdfDoc.embedPng(dataUrl);

                    page.drawImage(pngImage, {
                        x: 0,
                        y: 0,
                        width: width,
                        height: height,
                    });
                }
                
                showLoader('Finalizing document...');
                const finalPdfBytes = await newPdfDoc.save();
                download(finalPdfBytes, "edited-document.pdf", "application/pdf");

            } catch (error) {
                console.error("Error saving PDF:", error);
                alert("An error occurred while saving the PDF.");
            } finally {
                hideLoader();
            }
        }
        
        function download(data, filename, type) {
            const blob = new Blob([data], { type: type });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        function showLoader(text) {
            loaderText.textContent = text;
            loaderOverlay.classList.remove('hidden');
        }

        function hideLoader() {
            loaderOverlay.classList.add('hidden');
        }

        pdfUpload.addEventListener('change', handleFileSelect);
        downloadBtn.addEventListener('click', savePdf);
    </script>
</body>
</html>

